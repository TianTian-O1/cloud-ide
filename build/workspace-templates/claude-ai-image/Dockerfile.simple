# ç²¾ç®€ç‰ˆClaude AIå¼€å‘çŽ¯å¢ƒ
FROM codercom/code-server:latest

# åˆ‡æ¢åˆ° root ç”¨æˆ·
USER root
WORKDIR /app

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV TZ=Asia/Shanghai \
    DEBIAN_FRONTEND=noninteractive \
    NODE_ENV=production

# å®‰è£…å¿…è¦ä¾èµ–å’ŒClaude CLI
RUN apt-get update && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y --no-install-recommends \
        nodejs \
        python3 \
        python3-pip \
        curl \
        ca-certificates && \
    npm install -g @anthropic-ai/claude-code --silent && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /root/.npm

# é¢„å…ˆåˆ›å»ºé…ç½®ç›®å½•
RUN mkdir -p /root/.config/code-server /root/.local/share/code-server/User

# åˆ›å»º code-server é…ç½®
RUN cat > /root/.config/code-server/config.yaml << 'CONFIG_EOF'
bind-addr: 0.0.0.0:9999
auth: none
disable-update-check: true
disable-telemetry: true
CONFIG_EOF

# åˆ›å»º VS Code ç”¨æˆ·è®¾ç½®
RUN cat > /root/.local/share/code-server/User/settings.json << 'SETTINGS_EOF'
{
    "files.exclude": {
        "**/.*": true,
        "**/.git": true,
        "**/node_modules": true,
        "**/.vscode": false,
        "**/.gitignore": false,
        "**/.env": false
    },
    "files.autoSave": "afterDelay",
    "editor.minimap.enabled": false,
    "workbench.startupEditor": "none",
    "terminal.integrated.defaultProfile.linux": "bash"
}
SETTINGS_EOF

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start-claude.sh << 'SCRIPT_EOF'
#!/bin/bash

echo "ðŸš€ Claude AIåŠ©æ‰‹å¼€å‘çŽ¯å¢ƒå¯åŠ¨ä¸­..."

# ä½¿ç”¨ç”¨æˆ·æä¾›çš„APIé…ç½®
if [ -n "$ANTHROPIC_AUTH_TOKEN" ]; then
    export ANTHROPIC_API_KEY="$ANTHROPIC_AUTH_TOKEN"
    echo "âœ… å·²é…ç½®ç”¨æˆ·APIå¯†é’¥"
fi

if [ -n "$ANTHROPIC_BASE_URL" ]; then
    echo "âœ… å·²é…ç½®ç”¨æˆ·APIåœ°å€: $ANTHROPIC_BASE_URL"
fi

# åˆ›å»ºæ¬¢è¿Žæ–‡æ¡£
cat > /root/README.md << 'DOC_INNER_EOF'
# Claude AIåŠ©æ‰‹å¼€å‘çŽ¯å¢ƒ

## ä½¿ç”¨è¯´æ˜Ž

### 1. Claude CLI å‘½ä»¤
```bash
# ä¸ŽClaudeå¯¹è¯
claude "è¯·å¸®æˆ‘å†™ä¸€ä¸ªPythonå‡½æ•°"

# åˆ†æžä»£ç æ–‡ä»¶
claude --file app.py "è¯·ä¼˜åŒ–è¿™ä¸ªä»£ç "

# ç”Ÿæˆä»£ç 
claude "è¯·å†™ä¸€ä¸ªReactç»„ä»¶"
```

### 2. çŽ¯å¢ƒå˜é‡é…ç½®
- ANTHROPIC_API_KEY: æ‚¨çš„Claude APIå¯†é’¥
- ANTHROPIC_BASE_URL: APIåœ°å€ï¼ˆå¯é€‰ï¼‰

### 3. å¿«é€Ÿå¼€å§‹
åœ¨ç»ˆç«¯ä¸­è¾“å…¥ `claude --help` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤ã€‚

äº«å—ä¸ŽClaude AIçš„ç¼–ç¨‹ä¹‹æ—…ï¼ðŸŽ‰
DOC_INNER_EOF

echo "ðŸ“š å·²åˆ›å»ºä½¿ç”¨æ–‡æ¡£: /root/README.md"
echo "âœ… Claude CLIå·¥å…·å·²å°±ç»ª"
echo "ðŸ”§ å¯åŠ¨ Code Server..."

# å¯åŠ¨ code-server
exec /usr/bin/code-server \
    --bind-addr 0.0.0.0:9999 \
    --auth none \
    --disable-update-check \
    --disable-telemetry \
    "${WORKSPACE_DIR:-/root}"
SCRIPT_EOF

# è®¾ç½®è„šæœ¬æƒé™
RUN chmod +x /app/start-claude.sh

# æš´éœ²ç«¯å£
EXPOSE 9999

# è®¾ç½®å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/start-claude.sh"]
